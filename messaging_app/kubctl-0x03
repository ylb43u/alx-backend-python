#!/bin/bash
set -e

echo "ğŸš€ Applying updated Blue Deployment (v2.0)..."
kubectl apply -f blue_deployment.yaml

echo "ğŸ”„ Waiting for rolling update to complete..."
kubectl rollout status deployment/django-blue

echo "ğŸ“¡ Starting downtime test with curl..."
SERVICE_IP=$(minikube service django-service --url)

# Run curl requests in the background
for i in {1..20}; do
  if curl -s "$SERVICE_IP" > /dev/null; then
    echo "[$i] âœ… Request succeeded"
  else
    echo "[$i] âŒ Request failed"
  fi
  sleep 1
done

echo "ğŸ” Checking currently running pods..."
kubectl get pods -l app=django,version=blue -o wide

echo "âœ… Rolling update complete with version 2.0 deployed."
